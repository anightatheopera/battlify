{% extends "base.html" %}

{% block title %}Create - Lorian Awards{% endblock %}

{% block content %}
<div class="container">
    <h1>Create New Bracket</h1>
    <form id="create-form" onsubmit="submitCreationForm(event)" style="max-width: 600px; margin: 0 auto;">
        <div class="form-group">
            <label for="t-name">Tournament Name:</label>
            <input type="text" id="t-name" required placeholder="e.g., Best Ariana Grande Songs">
        </div>
        <div class="form-group">
            <label for="t-duration">Voting Duration per Round (minutes):</label>
            <input type="number" id="t-duration" min="1" value="1440" required> (Default: 1440 mins = 24 hours)
        </div>
        <div class="form-group">
            <label for="t-urls">Spotify URLs (One per line):</label>
            <p style="font-size: 0.8em; color: #aaa;">Accepts Tracks, Albums, or Playlists.</p>
            <textarea id="t-urls" rows="10" required placeholder="http://open.spotify.com/track/..."></textarea>
        </div>
        <button type="submit" id="submit-btn">Create Bracket</button>
        <p id="create-status"></p>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    if (!isLoggedIn()) { alert("Access Denied: Admins Only."); window.location.href = "/"; }

    async function submitCreationForm(event) {
        event.preventDefault();
        const statusDiv = document.getElementById('create-status');
        const submitBtn = document.getElementById('submit-btn');
        statusDiv.innerText = "Processing..."; statusDiv.style.color = "var(--accent-color)"; submitBtn.disabled = true;

        const name = document.getElementById('t-name').value;
        const duration = parseInt(document.getElementById('t-duration').value);
        const urls = document.getElementById('t-urls').value.split('\n').map(u => u.trim()).filter(u => u);

        try {
            const response = await authFetch('/api/admin/create', {
                method: 'POST',
                body: JSON.stringify({ name: name, voting_duration_minutes: duration, urls: urls })
            });
            if (response && response.ok) {
                const data = await response.json();
                statusDiv.innerHTML = "Success! Redirecting..."; statusDiv.style.color = "green";
                setTimeout(() => { window.location.href = `/manage/${data.tournament_id}`; }, 1000);
            } else {
                const err = await response.json();
                statusDiv.innerText = "Error: " + (err.detail || "Creation failed"); statusDiv.style.color = "red";
                submitBtn.disabled = false;
            }
        } catch (error) { statusDiv.innerText = "Network Error"; submitBtn.disabled = false; }
    }
</script>
{% endblock %}